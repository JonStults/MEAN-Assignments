<!DOCTYPE html>
<html ng-app="app">
	<head>
		<meta charset="utf-8">
		<title>The Wall</title>
		<!-- load jquery -->
		<script type="text/javascript" src="/static/js/jquery.min.js"></script>
		<!-- load bootstrap javascript -->
		<script type="text/javascript" src="/static/js/bootstrap.min.js"></script>
		<!-- load bootstrap CSS -->
		<link rel="stylesheet" type="text/css" href="/static/css/bootstrap.min.css">
		<!-- load style CSS -->
		<link rel="stylesheet" type="text/css" href="/static/css/style.css">

		<!-- load angularJS and its dependencies -->
		<script type="text/javascript" src="/angular/angular.min.js"></script>
		<script type="text/javascript" src="/angular-route/angular-route.min.js"></script>
		<script type="text/javascript" src="/angular-cookies/angular-cookies.min.js"></script>
		<script type="text/javascript" src="/angular-messages/angular-messages.min.js"></script>

		<!-- load angular.module and config
		<script type="text/javascript" src="/assets/app.js"></script>
		load factories: usersFactory
		<script type="text/javascript" src="/assets/factories/usersFactory.js"></script>
		load controllers: HomeController, UserController
		<script type="text/javascript" src="/assets/controllers/HomeController.js"></script>
		<script type="text/javascript" src="/assets/controllers/UserController.js"></script> -->

		<script type="text/javascript">
			var app = angular.module('app', ['ngRoute', 'ngCookies', 'ngMessages']);

			app.config(['$routeProvider', function($routeProvider) {
				$routeProvider
					.when('/wall', {
						templateUrl: "static/partials/wall.html",
						controller: "WallController"
					})
					.when('/login', {
						templateUrl: "static/partials/login.html",
						controller: "UserController"
					})
					.when('/register', {
						templateUrl: "static/partials/register.html",
						controller: "UserController"
					})
					.otherwise({
						redirectTo: '/wall'
					});
			}]);

			app.factory("usersFactory", ['$http', function($http) {

				function UsersFactory() {
					this.register = function(newUser, callback) {
						$http.post('/user/register', newUser).then(
							function success(response) {
								if (typeof(response.data.errors) != 'undefined') {
									// we have error
									callback(false, response.data.errors);
								}
								else {
									// successful
									callback(true, response.data);
								}
							},
							function error(response) {

							}
						);
					}

					this.login = function(loginUser, callback) {
						$http.post('/user', loginUser).then(
							function success(response) {
								if (typeof(response.data.errors) != 'undefined') {
									callback(false, response.data.errors);
								}
								else {
									callback(true, response.data);
								}
							},
							function error(response) {

							}
						);
					}
				}

				return new UsersFactory();
			}])

			app.controller("WallController", ['$scope', '$location', '$cookies', function($scope, $location, $cookies) {
				(function() {
					console.log($cookies.get('wall_username'));
					if ($cookies.get('wall_username') == undefined) {
						$location.url('/login');
					}
				})();

				$scope.logout = function() {
					$cookies.remove("wall_username");
					$location.url('/login');
				}

			}]);

			app.controller("UserController", ['$scope', '$location', '$cookies', 'usersFactory', function($scope, $location, $cookies, usersFactory){
				$scope.newUser = {
					password: "",
					confirm_password: ""
				};

				$scope.register = function() {
					console.log($scope.newUser);
					if ($scope.newUser.password != $scope.newUser.confirm_password) {
						$scope.match_fail = "Your password does not match the confirmed password! Please retype your passwords to match!";
					}
					else {
						$scope.match_fail = ""
						usersFactory.register($scope.newUser, function(status, response) {
							if (status == false) {
								$scope.registerErrors = response;
								// we have invalid error
							}
							else {
								$scope.registerErrors = {};
								$scope.newUser = {};
								$cookies.put('wall_username', response.username);
								$location.url('/wall');
							}
						});

					}
				}

				$scope.login = function() {
					usersFactory.login($scope.loginUser, function(status, response) {
						if (status == false) {
							$scope.loginError = response;
							$scope.loginUser.password = "";
						}
						else {
							$scope.loginUser = {};
							$scope.loginError = "";
							$cookies.put('wall_username', response.username);
							$location.url('/wall');
						}
					});
				}

			}]);
		</script>

	</head>
	<body>
		<div ng-view="">
				<!-- partials to be loaded in this div. -->
		</div>
	</body>
</html>
