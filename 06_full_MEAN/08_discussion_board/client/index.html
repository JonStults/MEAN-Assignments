<!DOCTYPE html>
<html ng-app="app">
	<head>
		<meta charset="utf-8">
		<title>Discussion Board</title>
		<!-- load jquery -->
		<script type="text/javascript" src="/static/js/jquery.min.js"></script>
		<!-- load bootstrap javascript -->
		<script type="text/javascript" src="/static/js/bootstrap.min.js"></script>
		<!-- load bootstrap CSS -->
		<link rel="stylesheet" type="text/css" href="/static/css/bootstrap.min.css">
		<!-- load style CSS -->
		<link rel="stylesheet" type="text/css" href="/static/css/style.css">

		<!-- load angularJS and its dependencies -->
		<script type="text/javascript" src="/angular/angular.min.js"></script>
		<script type="text/javascript" src="/angular-route/angular-route.min.js"></script>
		<script type="text/javascript" src="/angular-cookies/angular-cookies.min.js"></script>

		<!-- load angular.module and config
		<script type="text/javascript" src="/assets/app.js"></script>
		load factories: usersFactory, wallsFactory
		<script type="text/javascript" src="/assets/factories/usersFactory.js"></script>
		<script type="text/javascript" src="/assets/factories/wallsFactory.js"></script>
		load controllers: UserController, WallController
		<script type="text/javascript" src="/assets/controllers/UserController.js"></script>
		<script type="text/javascript" src="/assets/controllers/WallController.js"></script> -->

		<script type="text/javascript">
			var app = angular.module("app", ['ngRoute', 'ngCookies']);

			app.config(['$routeProvider', function($routeProvider) {
				$routeProvider
					.when('/dashboard', {
						templateUrl: "static/partials/dashboard.html",
						controller: "DashboardController"
					})
					.when('/login', {
						templateUrl: "static/partials/login.html",
						controller: "UserController"
					})
					.when('/topic/:id', {
						templateUrl: "static/partials/topic.html",
						controller: "TopicController"
					})
					.when('/user/:username', {
						templateUrl: "static/partials/user_profile.html",
						controller: "ProfileController"
					})
					.otherwise({
						redirectTo: '/dashboard'
					});
			}]);

			// usersFactory
			app.factory("usersFactory", ['$http', function($http) {

				function UsersFactory() {

					this.login = function(loginUser, callback) {
						$http.post('/user', loginUser).then(
							function success(response) {
								if (typeof(response.data.errors) != "undefined") {
									callback(false, response.data.errors);
								}
								else {
									callback(true, response.data);
								}
							},
							function error(response) {
								console.log("[Login: ERROR] could not login a user");
							}
						);
					}

					this.profileData = function(username, callback) {
						$http.get('/user/' + username).then(
							function success(response) {
								callback(response.data);
							},
							function error(response) {
								console.log("[profileData: ERROR] could not get user's profile data.");
							}
						);
					}

				}


				return new UsersFactory();
			}]);

			// topicsFactory
			app.factory("topicsFactory", ['$http', function($http) {

				function TopicsFactory() {

					this.create_topic = function(username, newTopic, callback) {
						newTopic.username = username;

						$http.post('/topic', newTopic).then(
							function success(response) {
								if (typeof(response.data.errors) != 'undefined') {
									callback(false, response.data.errors);
								}
								else {
									callback(true, response.data);
								}
							},
							function error(response) {
								console.log("[Create_topic: ERROR] could not create a new topic");
							}
						);
					}

					this.index = function(callback) {
						$http.get('/topic').then(
							function success(response) {

								callback(response.data);
							},
							function error(response) {
								console.log("[index (dashboard): ERROR] could not retrieve the topics from the DB");
							}
						);
					}

					this.single_topic = function(id, callback) {
						$http.get('/topic/' + id).then(
							function success(response) {
								if (typeof(response.data.errors) != 'undefined') {
									callback(false, response.data.errors);
								}
								else {
									callback(true, response.data);
								}
							},
							function error(response) {
								console.log("[single_topic: ERROR] could not retrieve a topic from the DB");
							}
						);
					}

					this.create_post = function(topic_id, username, newPost, callback) {
						newPost["username"] = username;
						$http.post('/post/' + topic_id, newPost).then(
							function success(response) {
								if (typeof(response.data.errors) != 'undefined') {
									callback(false, response.data.errors);
								}
								else {
									callback(true, response.data);
								}
							},
							function error(response) {
								console.log("[create_post: ERROR] could not create a new post!");
							}
						);
					}

					this.create_comment = function(post_id, username, newComment, callback) {
						var newComment = {
							username: username,
							comment: newComment
						};
						$http.post('/comment/' + post_id, newComment).then(
							function success(response) {
								if (typeof(response.data.errors) != 'undefined') {
									callback(false, response.data.errors);
								}
								else {
									callback(true, response.data);
								}
							},
							function error(response) {
								console.log("[create_comment: ERROR] could not create a new comment!");
							}
						);
					}

					this.index_posts = function(topic_id, callback) {
						$http.get('/post/' + topic_id).then(
							function success(response) {
								callback(response.data);
							},
							function error(response) {
								console.log("[index_post: ERROR] could not retrieve the posts from the DB!");
							}
						);
					}

					this.like_post = function(post_id) {
						$http.put('post/like/' + post_id).then(
							function success(response) {
								// nothing needs to happen
							},
							function error(response) {
								console.log("[like_post: ERROR] could not update the 'like' of the post from the DB!");
							}
						);
					}

					this.dislike_post = function(post_id) {
						$http.put('post/dislike/' + post_id).then(
							function success(response) {
								// nothing needs to happen
							},
							function error(response) {
								console.log("[dislike_post: ERROR] could not update the 'dislike' of the post from the DB!");
							}
						);
					}

				}

				return new TopicsFactory();
			}]);

			// UserController
			app.controller("UserController", ['$scope', '$location', '$cookies','usersFactory', 'topicsFactory', function($scope, $location, $cookies, usersFactory, topicsFactory) {

				$scope.login = function() {

					usersFactory.login($scope.loginUser, function(status, response) {
						if (status == false) {
							$scope.loginError = response;
						}
						else {
							$scope.loginError = {}; // clear errors
							$scope.loginUser = {}; // clear login form
							$cookies.put('discussion_username', response.username);
							$location.url('/dashboard');
						}
					});
				}

			}]);

			// DashboardController
			app.controller("DashboardController", ['$scope', '$location', '$cookies', 'usersFactory', 'topicsFactory', function($scope, $location, $cookies, usersFactory, topicsFactory) {
				$scope.topics = [];

				// callback function for obtaining all the topics
				var getTopics = function(topics) {
					$scope.topics = topics;
				};

				// immediate function to prevent non logged-in user access
				(function() {
					// if cookie does not exist, redirect client to the login page
					if ($cookies.get('discussion_username') == undefined) {
						$location.url('/login');
					}
					else { // else retrieve user's data and all the topics from the DB
						$scope.username = $cookies.get('discussion_username');
						topicsFactory.index(getTopics);
					}
				})();

				$scope.create_topic = function() {

					topicsFactory.create_topic($scope.username, $scope.newTopic, function(status, response) {
						if (status == false) {
							$scope.topicErrors = response;
						}
						else {
							// push to the topics
							$scope.topics.push(response);

							$scope.topicErrors = {}; // clear topic errors
							$scope.newTopic = {}; // clear the topic form
						}
					});


				}

				$scope.logout = function() {
					$cookies.remove('discussion_username');
					$location.url('/login');
				}

			}]);

			// TopicController
			app.controller("TopicController", ['$scope', '$location', '$cookies', '$routeParams', 'topicsFactory', function($scope, $location, $cookies, $routeParams, topicsFactory) {
				// immediate function to prevent non logged-in user access
				(function() {
					// if cookie does not exist, redirect client to the login page
					if ($cookies.get('discussion_username') == undefined) {
						$location.url('/login');
					}
					else { // else retrieve user's data and all the topics from the DB
						$scope.username = $cookies.get('discussion_username');
						topicsFactory.single_topic($routeParams.id , function(status, topic) {
							if (status == false) {// the topic cannot be found using the id
								// redirect the client to the dashboard
								$location.url('/dashboard');
							}
							else {
								$scope.topic = topic;
							}
						});

						topicsFactory.index_posts($routeParams.id, function(posts) {
							$scope.posts = posts;
						});
					}
				})();

				$scope.create_post = function(topic_id) {

					topicsFactory.create_post(topic_id, $scope.username, $scope.newPost, function(status, response) {
						if (status == false) {
							$scope.postError = response;
						}
						else {
							$scope.postError = {};
							$scope.newPost = {};
							$scope.posts.push(response);
						}
					});
				}

				$scope.create_comment = function(index) {
					var newComment = $scope.posts[$scope.posts.length - 1 - index].newComment;
					var post_id = $scope.posts[$scope.posts.length - 1 - index]._id;

					topicsFactory.create_comment(post_id, $scope.username, newComment, function(status, response) {
						if (status == false) {
							$scope.commentError = response;
						}
						else {
							$scope.commentError = {};
							delete $scope.posts[$scope.posts.length - 1 - index].newComment;
							$scope.posts[$scope.posts.length - 1 - index]._comments.push(response);
						}
					});

				}

				$scope.like_post = function(index) {
					var post_owner = $scope.posts[$scope.posts.length - 1 - index].username;
					if ($scope.username == post_owner) {
						// cannot vote your own stuff...
						// display error
						console.log("you cannot like your own post!");
					}
					else {
						var post_id = $scope.posts[$scope.posts.length - 1 - index]._id;
						topicsFactory.like_post(post_id); // tell factory to update the DB, no need to callback since its just +1 to the like
						// update it on the view for realtime update
						$scope.posts[$scope.posts.length - 1 - index].like += 1;
					}
				}

				$scope.dislike_post = function(index) {
					var post_owner = $scope.posts[$scope.posts.length - 1 - index].username;
					if ($scope.username == post_owner) {
						// cannot vote your own stuff...
						// display error
						console.log("you cannot dislike your own post!");
					}
					else {
						var post_id = $scope.posts[$scope.posts.length - 1 - index]._id;
						topicsFactory.dislike_post(post_id); // tell factory to update the DB, no need to callback since its just +1 to the dislike
						// update it on the view for realtime update
						$scope.posts[$scope.posts.length - 1 - index].dislike += 1;
					}
				}

				$scope.logout = function() {
					$cookies.remove('discussion_username');
					$location.url('/login');
				}

			}]);

			// ProfileController
			app.controller("ProfileController", ['$scope', '$location', '$cookies', '$routeParams', 'usersFactory', function($scope, $location, $cookies, $routeParams, usersFactory) {
				// immediate function to prevent non logged-in user access
				(function() {
					// if cookie does not exist, redirect client to the login page
					if ($cookies.get('discussion_username') == undefined) {
						$location.url('/login');
					}
					else { // else retrieve user's profile data based on the $routeParams.username
						$scope.username = $routeParams.username;
						usersFactory.profileData($scope.username, function(response) {
							$scope.count = response;

						});
					}
				})();
			}]);
		</script>

	</head>
	<body>
		<div ng-view="">
			<!-- partials to be loaded in this div. -->
		</div>
	</body>
</html>
